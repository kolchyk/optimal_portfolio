


Проблема, которую вы описываете (стратегия половину времени проигрывает обычному Buy & Hold по S&P 500 и находится ниже границы эффективности Марковица на графике риска/доходности), очень типична для тренд-следящих (Momentum) стратегий с жесткими правилами риск-менеджмента.

Анализ вашего кода выявляет несколько **фундаментальных архитектурных узких мест**, которые мешают стратегии обгонять индекс и оптимизировать соотношение риск/доходность.

Вот основные причины недополученной прибыли и способы радикально улучшить стратегию.

---

### 1. Глобальный фильтр по SPY (Самая критичная ошибка для Cross-Asset)
**Где в коде:** `engine.py` и `strategy_v2/engine.py` (блок `risk_off`).
**Проблема:** Как только индекс S&P 500 (SPY) падает ниже своей скользящей средней (KAMA), стратегия **распродает абсолютно все активы в кэш**. У вас отличный диверсифицированный набор ETF (золото `GLD`, облигации `TLT`, крипта `BTC-USD`). Но когда акции США падают, защитные активы (золото, трежерис) обычно растут! Сбрасывая их вместе со SPY, вы лишаете портфель защитной диверсификации.
**Как улучшить:**
*   **Убрать глобальный SPY-фильтр для некоррелирующих активов.** Применяйте SPY-фильтр *только* к акциям (US Equity, Sector ETFs).
*   **Или заменить выход в кэш на ротацию:** Если SPY падает ниже KAMA, запретите покупку новых акций, но разрешите покупать топовые по моментуму защитные активы (Бонды, Металлы).

### 2. Проблема "Lazy Hold" (Зависание капитала в мертвых активах)
**Где в коде:** `engine.py` (описание: *«positions are sold ONLY when their own KAMA stop-loss triggers, never because they dropped in the momentum ranking»*).
**Проблема:** Стратегия держит актив до тех пор, пока он не пробьет свою KAMA вниз. Это значит, что если актив вырос, а потом перешел в долгий боковик (оставаясь чуть выше KAMA), капитал "замораживается". В это же время другие активы могут показывать мощнейший рост, но стратегия их не купит, так как нет пустых слотов (`open_slots`). Из-за этого вы сильно отстаете от Buy & Hold на бычьих рынках.
**Как улучшить:**
*   **Ввести Relative Momentum Stop:** Продавать актив не только по KAMA, но и если он сильно упал в рейтинге. Например, если вы держите топ-10 (`TOP_N=10`), продавайте актив, если его ранг моментума упал ниже 25-го места. Освободившиеся деньги перекладывайте в текущий Топ-1-5.
*   **Ввести Time Stop или Trailing Stop:** Если актив не показывает доходности X% за Y дней, закрывать позицию.

### 3. Неэффективное построение портфеля (Почему вы под кривой Марковица)
**Где в коде:** `engine.py` функция `_compute_inverse_vol_weights_fast`.
**Проблема:** Сейчас используется Inverse Volatility (Risk Parity). Это лучше, чем равные доли, но этот метод **игнорирует ковариацию (корреляцию) между активами в портфеле**. Он просто дает меньше веса волатильным активам. Из-за этого портфель не является математически оптимальным по Шарпу, поэтому он и лежит под Efficient Frontier.
**Как улучшить:**
*   **Внедрить Mean-Variance Optimization (Марковиц) или HRP (Hierarchical Risk Parity).** Вместо простого `inv_vol` используйте матрицу ковариации `recent_rets.cov()` для расчета весов, которые максимизируют ожидаемый Шарп.
*   В текущем виде ваш жесткий фильтр корреляций (`p.corr_threshold`) просто отбрасывает активы. Лучше брать их, но с правильным балансирующим весом.

### 4. Ошибка волатильного таргетирования (V2 Volatility Targeting)
**Где в коде:** `strategy_v2/engine.py` (расчет `current_scale = p.target_vol / realized_vol`).
**Проблема:** В периоды рыночных крахов (например, март 2020) волатильность взлетает до небес. Стратегия V2 реагирует на это резким снижением `current_scale` (делеверидж), сокращая позиции на самом дне рынка. Когда рынок начинает V-образный отскок (самые прибыльные дни S&P 500 исторически следуют сразу за обвалами), ваша стратегия сидит с урезанными позициями и пропускает рост.
**Как улучшить:**
*   **Асимметричное таргетирование:** Уменьшайте позицию при росте "плохой" волатильности (downside deviation), но не режьте её при росте волатильности вверх.
*   Увеличьте окно оценки волатильности `portfolio_vol_lookback`, чтобы система не паниковала из-за 2-3 плохих дней.

### 5. Потеря доходности на кэше (Cash Drag)
**Проблема:** Когда срабатывают стопы KAMA, капитал уходит в кэш (зарабатывая скромный `RISK_FREE_RATE`). В долгосроке кэш всегда проигрывает активам.
**Как улучшить:**
*   Если слоты пустуют (нет активов, проходящих фильтр), инвестируйте остаток не в чистый кэш, а в **сверхнадежные ETF** (например, `SHV`, `SGOV` или `BIL` — они дают реальную доходность по векселям без просадок).
*   **Canary Universe:** Создайте резервный список (например, `IEF`, `TLT`, `GLD`). Если основные активы не проходят фильтр, капитал паркуется в резервный список по принципу абсолютного моментума.

---

### План действий (Что изменить в коде прямо сейчас):

**Шаг 1: Измените логику SPY Фильтра в `engine.py`:**
Вместо того, чтобы ликвидировать всё (`sells[t] = 0.0`), сделайте так, чтобы при падении SPY продавались только акции США.
```python
# Добавьте маппинг секторов в параметры или используйте ASSET_CLASS_MAP из config.py
from src.portfolio_sim.config import ASSET_CLASS_MAP

# ... внутри цикла days ...
if risk_off:
    # Продаем ТОЛЬКО акции (US/Intl/EM Equity, Sector ETFs)
    for t in list(shares.keys()):
        asset_class = ASSET_CLASS_MAP.get(t, "US Equity")
        if "Equity" in asset_class or "Sector ETF" in asset_class:
            sells[t] = 0.0
    # Кандидаты теперь могут быть только защитными активами
    candidates =[c for c in get_buy_candidates(...) if "Bonds" in ASSET_CLASS_MAP.get(c, "") or "Metals" in ASSET_CLASS_MAP.get(c, "")]
else:
    # Стандартная логика
```

**Шаг 2: Модифицируйте "Lazy Hold" (добавьте проверку ранга):**
В `engine.py`, там где вы проверяете `t_kama`:
```python
# Рассчитайте моментум всех активов ДО цикла продаж
current_scores = momentum_df.loc[date] * (er_df.loc[date] ** 2 if p.use_risk_adjusted else 1)
current_scores = current_scores.sort_values(ascending=False)
top_25_percent = current_scores.head(p.top_n * 2).index.tolist()

for t in list(shares.keys()):
    t_kama = kama_row.get(t, np.nan)
    if not np.isnan(t_kama):
        # Продаем, если пробили тренд вниз ИЛИ если актив сильно отстал от лидеров (выпал из топ-2x)
        if daily_close.get(t, 0.0) < t_kama * (1 - p.kama_buffer) or t not in top_25_percent:
            sells[t] = 0.0
```

**Шаг 3: Снизьте транзакционные издержки:**
В `config.py` у вас `COMMISSION_RATE = 0.0002` и `SLIPPAGE_RATE = 0.0005`. Это 0.07% на сделку, 0.14% на круг. При частой ребалансировке (особенно в V2 с функцией `trim`) это съедает существенную долю CAGR.
Увеличьте `KAMA_BUFFER` (чтобы меньше "пилить" на боковиках) или в V2 сделайте порог тримминга больше (например, резать позицию только если вес отклонился на 10%, а не на 5%).

**Итог:** Ваша стратегия сейчас ведет себя как **излишне пугливый тренд-фолловер**. Она слишком часто убегает в кэш и слишком долго сидит в медленных активах. Если вы позволите ей агрессивнее ротироваться внутри `TOP_N` лидеров и перестанете распродавать облигации/золото при падении акций США, кривая доходности заметно обгонит SPY и поднимется к границе эффективности.