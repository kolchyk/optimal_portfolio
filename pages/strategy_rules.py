"""Strategy rules explanation page — R² Momentum (Ukrainian, beginner-friendly)."""

from collections import Counter

import streamlit as st

from src.portfolio_sim.config import (
    ASSET_CLASS_MAP,
    ATR_PERIOD,
    COMMISSION_RATE,
    DEFAULT_N_TRIALS,
    ETF_UNIVERSE,
    GAP_THRESHOLD,
    INITIAL_CAPITAL,
    KAMA_BUFFER,
    KAMA_PERIOD,
    KAMA_SPY_PERIOD,
    R2_LOOKBACK,
    R2_SEARCH_SPACE,
    REBAL_PERIOD_WEEKS,
    RISK_FACTOR,
    RISK_FREE_RATE,
    SLIPPAGE_RATE,
    TOP_N,
)

_BUFFER_PCT = KAMA_BUFFER * 100
_GAP_PCT = GAP_THRESHOLD * 100
_N_ETF = len(ETF_UNIVERSE)
_ASSET_CLASS_COUNTS = Counter(ASSET_CLASS_MAP.values())
_N_ASSET_CLASSES = len(_ASSET_CLASS_COUNTS)
_N_SENSITIVITY = DEFAULT_N_TRIALS
_R2_PARAM_NAMES = list(R2_SEARCH_SPACE.keys())


def page():
    st.title("Правила стратегії R² Momentum")
    st.caption(
        "Clenow-style | Long/Cash | Cross-Asset ETF | "
        "ATR Risk Parity | Lazy-Hold ребалансування"
    )

    # ------------------------------------------------------------------
    # 1. Overview
    # ------------------------------------------------------------------
    st.header("1. Що це за стратегія?")
    st.markdown(
        """
Це **систематична моментум-стратегія** за методологією Андреаса Кленова
("Stocks on the Move"). Вона оцінює якість тренду кожного активу через
**OLS-регресію** та купує найкращі, поки їхній тренд тримається.

**Ключова ідея:** ми фітимо лінійну регресію до логарифма ціни за останні
N днів. Нахил цієї прямої (slope) — це щоденна дохідність тренду. R² показує,
наскільки стабільно ціна слідує цьому тренду. Їхній добуток
`annualized_slope × R²` — це наш **R² Momentum Score**.

**Простими словами:** ми купуємо активи, що зростають стабільно і впевнено.
Хаотичний рух — навіть з високою дохідністю — штрафується.

**Тип стратегії:** Long/Cash — ми або тримаємо активи, або готівку.
Ніколи не "шортимо" (не граємо на зниження).
        """
    )

    st.info(
        f"**Cross-Asset ETF** — {_N_ETF} активів з {_N_ASSET_CLASSES} класів "
        "(акції, облігації, товари, нерухомість, крипто). "
        "Тактична всепогодна алокація з ATR risk parity."
    )

    # ------------------------------------------------------------------
    # 2. Asset universe
    # ------------------------------------------------------------------
    st.header("2. Всесвіт активів")

    with st.expander("Склад Cross-Asset ETF по класах активів"):
        class_data = sorted(_ASSET_CLASS_COUNTS.items(), key=lambda x: -x[1])
        st.table(
            {
                "Клас активу": [c for c, _ in class_data],
                "Кількість": [n for _, n in class_data],
            }
        )

    # ------------------------------------------------------------------
    # 3. KAMA indicator
    # ------------------------------------------------------------------
    st.header("3. Індикатор KAMA (тренд-фільтр)")
    st.markdown(
        f"""
**KAMA** (Kaufman's Adaptive Moving Average) — адаптивна ковзна середня,
яка автоматично прискорюється в трендових ринках і сповільнюється у боковиках.

- **Період для активів:** `{KAMA_PERIOD}` торгових днів
- **Період для SPY (режимний фільтр):** `{KAMA_SPY_PERIOD}` торгових днів

KAMA використовує *Efficiency Ratio* (відношення чистого руху ціни до
сумарної волатильності). Якщо ціна рухається стабільно — KAMA швидко
слідує за нею. У боковому ринку — майже не рухається.

> **Для початківця:** уявіть KAMA як "розумну лінію тренду", яка
> йде за ціною, але не смикається від кожного дрібного коливання.

В R² Momentum стратегії KAMA використовується як **тренд-фільтр**
(вхід/вихід), а не для ранжування моментуму.
        """
    )

    # ------------------------------------------------------------------
    # 4. Candidate selection pipeline
    # ------------------------------------------------------------------
    st.header("4. Як обираємо активи? (Пайплайн відбору)")

    st.markdown(
        f"""
Актив потрапляє в портфель через чотири послідовні кроки:

**Крок 1 — Режимний фільтр SPY:**
Ціна SPY > KAMA(SPY) × (1 − {_BUFFER_PCT:.1f}%). Якщо ринок у
"ведмежому" режимі — весь портфель виходить у кеш.

**Крок 2 — KAMA-фільтр активу:**
Ціна закриття активу > KAMA × (1 − {_BUFFER_PCT:.1f}%). Актив має
бути вище свого тренду.

**Крок 3 — Фільтр гепів:**
Жодного одноденного руху > {_GAP_PCT:.0f}% за останні `{R2_LOOKBACK}` днів.
Це відсіює активи зі спотвореним трендом через сплити, earnings gaps тощо.
        """
    )

    st.subheader("Крок 4 — R² Momentum скоринг і відбір Top-N")
    st.markdown(
        f"""
**Ранжування за R² Momentum Score (метод Кленова).**

Формула: `score = annualized_slope × R²`

Для кожного активу фітимо OLS-регресію до логарифму ціни за останні
`{R2_LOOKBACK}` днів:
- **annualized_slope** — нахил регресії × 252 (річна дохідність тренду)
- **R²** — коефіцієнт детермінації (0..1), вимірює «гладкість» тренду

**Множник R² штрафує нестабільний рух:**
- R² = 0.9 (ідеальний тренд) → зберігає 90% скору
- R² = 0.5 (шумний тренд) → зрізає 50%
- R² = 0.2 (хаотичний рух) → залишає лише 20%

Відбираємо **Top-{TOP_N}** активів з найвищим score > 0.

> **Аналогія:** якщо два активи зросли на 30% за період, перевагу
> отримає той, чий графік схожий на пряму лінію, а не на хаотичний
> зигзаг.
        """
    )

    # ------------------------------------------------------------------
    # 5. Sell rules
    # ------------------------------------------------------------------
    st.header("5. Коли продаємо? (Lazy Hold)")
    st.markdown(
        f"""
Позиція продається при будь-якій із цих умов:

- **KAMA-стоп:** ціна закриття < KAMA × (1 − {_BUFFER_PCT:.1f}%)
- **SPY режим off:** SPY впав нижче свого KAMA — весь портфель у кеш
- **R² Score < 0** або актив не пройшов фільтри (гепи, KAMA) на дату ребалансу

Позиція **НЕ** продається лише тому, що актив випав з Топ-{TOP_N}
за моментумом. Поки його власний тренд тримається — ми тримаємо позицію.

Ребалансування (перевірка сигналів) відбувається кожні
**{REBAL_PERIOD_WEEKS} тижні**, а не щодня. Це зменшує оборотність
і комісійні витрати.

> **Для початківця:** це як індивідуальний захист для кожного активу.
> Ми перевіряємо портфель регулярно, але не панікуємо щодня.
        """
    )

    # ------------------------------------------------------------------
    # 6. Risk management — 3 pillars
    # ------------------------------------------------------------------
    st.header("6. Три стовпи управління ризиком")

    col1, col2, col3 = st.columns(3)

    with col1:
        st.subheader("Гістерезис")
        st.markdown(
            f"""
**"Дихання ринку"**

Буфер ±{_BUFFER_PCT:.1f}% навколо KAMA запобігає хибним
перемиканням у боковому ринку.

**Аналогія:** як термостат з допуском — він не вмикає обігрів
при кожному коливанні температури на 0.1°.
            """
        )

    with col2:
        st.subheader("Lazy Hold")
        st.markdown(
            """
**"Лінивий" стоп-лосс**

Позиції тримаються, поки їхній власний тренд тримається
(ціна > KAMA). Ми не продаємо актив лише тому, що він випав
з Топ-N, якщо він все ще зростає.

_Детальніше — у секції 5._
            """
        )

    with col3:
        st.subheader("ATR Risk Parity")
        st.markdown(
            f"""
**Розмір позицій за ATR**

Вага кожного активу пропорційна:
`risk_factor / (ATR / price)`

Де ATR — середнє абсолютне денне зміщення
за `{ATR_PERIOD}` днів.

Спокійні активи (облігації) отримують більше
капіталу, волатильні (крипто) — менше.

> **Аналогія:** кожен актив "ризикує" приблизно однаково.
            """
        )

    # ------------------------------------------------------------------
    # 7. Parameters table
    # ------------------------------------------------------------------
    st.header("7. Параметри стратегії")

    tab_core, tab_adv = st.tabs(["Основні параметри", "Додаткові параметри"])

    with tab_core:
        st.table(
            {
                "Параметр": [
                    "Період даних",
                    "Початковий капітал",
                    "R² Lookback",
                    "Період KAMA (актив)",
                    "Період KAMA (SPY)",
                    "Буфер KAMA (гістерезис)",
                    "Кількість позицій (Top N)",
                    "Період ребалансування",
                    "Комісія за угоду",
                    "Прослизання (slippage)",
                    "Безризикова ставка",
                ],
                "За замовч.": [
                    "3 роки",
                    f"${INITIAL_CAPITAL:,.0f}",
                    f"{R2_LOOKBACK} днів",
                    f"{KAMA_PERIOD} днів",
                    f"{KAMA_SPY_PERIOD} днів",
                    f"±{_BUFFER_PCT:.1f}%",
                    f"{TOP_N} активів",
                    f"{REBAL_PERIOD_WEEKS} тижні",
                    f"{COMMISSION_RATE:.2%} ({COMMISSION_RATE * 10_000:.0f} bps)",
                    f"{SLIPPAGE_RATE:.2%} ({SLIPPAGE_RATE * 10_000:.0f} bps)",
                    f"{RISK_FREE_RATE:.0%} річних",
                ],
                "Діапазон": [
                    "3 – 5 років",
                    "$1,000 – $10,000,000",
                    "20 – 120 днів",
                    "10 – 50 днів",
                    "20 – 50 днів",
                    "0.5% – 3.0%",
                    "5 – 25",
                    "1 – 6 тижнів",
                    "(фіксовано)",
                    "(фіксовано)",
                    "(фіксовано)",
                ],
                "Пояснення": [
                    "Скільки років історичних даних завантажувати",
                    "Сума, з якою стартує симуляція",
                    "Вікно OLS-регресії для скорингу моментуму",
                    "Вікно KAMA для індивідуального тренд-фільтру",
                    "Вікно KAMA для режимного фільтру SPY",
                    "Захист від хибних перемикань бик/ведмідь",
                    "Максимум активів у портфелі одночасно",
                    "Як часто перевіряємо сигнали (lazy-hold)",
                    "Витрати брокера на кожну операцію",
                    "Різниця між очікуваною і реальною ціною",
                    "Для розрахунку коефіцієнта Шарпа",
                ],
            }
        )

    with tab_adv:
        st.table(
            {
                "Параметр": [
                    "Поріг гепів",
                    "Період ATR",
                    "Risk Factor",
                ],
                "За замовч.": [
                    f"{GAP_THRESHOLD:.0%}",
                    f"{ATR_PERIOD} днів",
                    f"{RISK_FACTOR} ({RISK_FACTOR * 10_000:.0f} bps)",
                ],
                "Пояснення": [
                    "Виключення активів з одноденним рухом > порога",
                    "Вікно для розрахунку ATR (розмір позицій)",
                    "Ризик на позицію в день (для ATR risk parity)",
                ],
            }
        )

    st.info(
        "Усі параметри можна змінювати на дашборді через бічну панель. "
        "Увімкніть **Walk-Forward** оптимізацію для автоматичного підбору "
        "параметрів (Optuna TPE семплер)."
    )

    # ------------------------------------------------------------------
    # 8. Execution model
    # ------------------------------------------------------------------
    st.header("8. Як виконуються угоди?")
    st.markdown(
        f"""
| Крок | Час | Дія |
|------|-----|-----|
| 1 | Кожні {REBAL_PERIOD_WEEKS} тижні, закриття дня T | Аналізуємо сигнали: SPY KAMA, asset KAMA, gap filter, R² scoring |
| 2 | Закриття дня T | Визначаємо продажі (KAMA breach, failed filters) та покупки (нові top-N кандидати) |
| 3 | Відкриття дня T+1 | Виконуємо угоди за ціною відкриття |
| 4 | Закриття дня T+1 | Переоцінка портфеля (mark-to-market) |

> **Чому не на закритті?** Сигнали формуються на закритті, але торгувати
> за тією ж ціною неможливо в реальності. Виконання на відкритті наступного
> дня — це більш реалістична модель.

> **Lazy-Hold:** між датами ребалансування позиції утримуються без змін.
> Це знижує оборотність та комісійні витрати.
        """
    )

    # ------------------------------------------------------------------
    # 9. Walk-Forward Optimization
    # ------------------------------------------------------------------
    st.header("9. Walk-Forward оптимізація параметрів")
    st.markdown(
        f"""
**Мета:** знайти параметри, що працюють не лише на історичних даних,
а й на нових, невидимих даних (out-of-sample).

**Як це працює?** Дані розбиваються на скользні вікна:
- **In-Sample (IS):** тренувальне вікно — оптимізуємо параметри
- **Out-of-Sample (OOS):** валідаційне вікно — перевіряємо якість

**Цільова функція:** CAGR (максимізація) з обмеженням MaxDD < 30%.

Простір пошуку ({_N_SENSITIVITY} триалів Optuna TPE на кожний крок):
        """
    )

    grid_data = {
        "Параметр": [],
        "Простір пошуку": [],
    }
    for name in _R2_PARAM_NAMES:
        spec = R2_SEARCH_SPACE[name]
        grid_data["Параметр"].append(name)
        if spec.get("type") == "categorical":
            grid_data["Простір пошуку"].append(
                ", ".join(str(v) for v in spec["choices"])
            )
        else:
            grid_data["Простір пошуку"].append(
                f"{spec['low']} – {spec['high']}, крок {spec['step']}"
            )
    st.table(grid_data)

    st.markdown(
        """
**Деградація IS → OOS:** якщо OOS CAGR < 50% від IS CAGR — попередження
про можливе переобучення.

Запустити walk-forward оптимізацію:
`uv run python -m src.portfolio_sim walk-forward`
        """
    )

    # ------------------------------------------------------------------
    # 10. Efficient frontier
    # ------------------------------------------------------------------
    st.header("10. Ефективна межа Марковіца")
    st.markdown(
        """
На дашборді є графік **Risk-Return Distribution & Efficient Frontier**.

**Ефективна межа (Efficient Frontier)** — це набір портфелів, які
пропонують **найвищу дохідність для кожного рівня ризику**.

**Як читати графік:**
- **Кожна точка** — один актив (волатильність по X, дохідність по Y)
- **Золота крива** — ефективна межа
- **Зелена зірка** — позиція вашого портфеля
- **Сірий ромб** — S&P 500 (бенчмарк)

> **Аналогія:** ефективна межа — це як межа швидкості автомобіля.
> Ви можете їхати повільніше, але не швидше без збільшення ризику.
        """
    )

    # ------------------------------------------------------------------
    # 11. Advantages
    # ------------------------------------------------------------------
    st.header("11. Переваги підходу")
    st.markdown(
        """
**Чому R² Momentum краща за наївний "купи і тримай"?**

- **Якість тренду, а не лише дохідність.** R²-множник жорстко карає
  хаотичний рух — стратегія обирає активи з гладким, надійним трендом.

- **Захист від великих просадок.** SPY KAMA режимний фільтр переводить
  весь портфель у кеш при ведмежому ринку. Це рятує капітал під час
  криз (2008, 2020, 2022).

- **Крос-активна диверсифікація.** Портфель включає не лише акції,
  а й облігації, золото, нерухомість — "всепогодний" ефект.

- **ATR Risk Parity.** Розмір позицій пропорційний реальній волатильності
  (ATR), а не просто рівним вагам. Спокійні активи отримують більше
  капіталу.

- **Низька оборотність.** Lazy-Hold ребалансування кожні
  N тижнів зменшує кількість угод = менше комісій та прослизань.

- **Науково обґрунтована основа.** Методологія Кленова ("Stocks on
  the Move") підтверджена десятиліттями досліджень моментум-ефекту.
        """
    )

    # ------------------------------------------------------------------
    # 12. Glossary
    # ------------------------------------------------------------------
    with st.expander("Словник термінів для початківців"):
        st.markdown(
            f"""
- **R² (коефіцієнт детермінації)** — міра того, наскільки добре
  лінійна регресія описує дані. R² = 1 — ідеальна пряма,
  R² = 0 — хаотичний рух. Використовується як множник для
  штрафування нестабільних трендів.
- **OLS-регресія** — метод найменших квадратів. Фітуємо пряму лінію
  до логарифму ціни за N днів. Нахил (slope) показує середню
  щоденну дохідність тренду.
- **R² Momentum Score** — `annualized_slope × R²`. Основна метрика
  для ранжування активів. Високий скор = сильний і стабільний тренд.
- **ATR (Average True Range)** — середній денний діапазон руху ціни.
  Використовується для визначення розміру позицій. Високий ATR = більша
  волатильність = менша позиція.
- **Risk Factor** — ризик на позицію в день ({RISK_FACTOR * 10_000:.0f} bps).
  Визначає, скільки капіталу виділяється на кожен актив відносно його ATR.
- **Моментум** — тенденція активів, що зростали нещодавно,
  продовжувати зростання.
- **KAMA** — адаптивна ковзна середня, що реагує на силу тренду.
  Розроблена Перрі Кауфманом. В R² стратегії використовується як
  тренд-фільтр.
- **Гістерезис** — буфер, що запобігає частим хибним перемиканням.
- **Gap (геп)** — різкий одноденний стрибок ціни (>15%).
  Гепи спотворюють регресійний скор, тому такі активи виключаються.
- **Просадка (Drawdown)** — максимальне падіння вартості портфеля
  від піку до дна.
- **Коефіцієнт Шарпа (Sharpe Ratio)** — міра дохідності з
  урахуванням ризику. Показує скільки додаткової дохідності
  (понад безризикову ставку {RISK_FREE_RATE:.0%}) ви отримуєте
  на кожну одиницю ризику. > 1 вважається хорошим.
- **Calmar Ratio** — відношення річної дохідності до максимальної
  просадки.
- **CAGR** — середньорічна дохідність (Compound Annual Growth Rate).
- **Ефективна межа (Efficient Frontier)** — крива Марковіца, що
  показує оптимальні портфелі для кожного рівня ризику.
- **Walk-Forward Optimization** — ковзна оптимізація: тренуємо
  параметри на IS-вікні, валідуємо на OOS-вікні. Захист від
  переобучення (overfitting).
- **Lazy Hold** — позиція утримується, поки її тренд тримається,
  навіть якщо вона випала з Топ-N. Зменшує оборотність.
- **Long/Cash** — стратегія, що або тримає активи (long), або кеш.
- **ETF (Exchange-Traded Fund)** — біржовий фонд.
- **SPY** — ETF, що відтворює індекс S&P 500. Використовується
  як бенчмарк та режимний фільтр.
            """
        )


page()
