"""Strategy rules explanation page (Ukrainian, beginner-friendly)."""

import streamlit as st

from src.portfolio_sim.config import (
    COMMISSION_RATE,
    INITIAL_CAPITAL,
    KAMA_BUFFER,
    KAMA_PERIOD,
    LOOKBACK_PERIOD,
    RISK_FREE_RATE,
    SLIPPAGE_RATE,
    TOP_N,
)

_BUFFER_PCT = KAMA_BUFFER * 100


def page():
    st.title("Правила стратегії KAMA Momentum")
    st.caption(
        "Long/Cash | Рівна вага | Всесвіт S&P 500 | Щоденний перегляд KAMA"
    )

    # ------------------------------------------------------------------
    # 1. Overview
    # ------------------------------------------------------------------
    st.header("1. Що це за стратегія?")
    st.markdown(
        """
Це **систематична моментум-стратегія**, яка інвестує лише в акції
зі складу індексу S&P 500. Вона не намагається "вгадати" ринок,
а слідує за чіткими математичними правилами.

**Простими словами:** ми купуємо акції, які зростають найшвидше,
і тримаємо їх, поки їхній власний тренд не зламається. Коли весь
ринок стає ведмежим — виходимо в кеш (готівку) і чекаємо.

**Тип стратегії:** Long/Cash — ми або тримаємо акції, або готівку.
Ніколи не "шортимо" (не граємо на зниження).
        """
    )

    # ------------------------------------------------------------------
    # 2. KAMA indicator
    # ------------------------------------------------------------------
    st.header("2. Індикатор KAMA")
    st.markdown(
        f"""
**KAMA** (Kaufman's Adaptive Moving Average) — це адаптивна ковзна
середня, яка автоматично прискорюється в трендових ринках і
сповільнюється у боковиках.

- **Період:** `{KAMA_PERIOD}` торгових днів (приблизно 2 тижні)
- На відміну від звичайної ковзної середньої (SMA або EMA), KAMA менше
  "шумить" у боковому ринку, але швидко реагує на початок тренду.

**Як це працює?** KAMA використовує так званий *Efficiency Ratio* —
відношення чистого руху ціни до сумарної волатильності. Якщо ціна
рухається стабільно в одному напрямку — KAMA швидко слідує за нею.
Якщо ринок "пилить" туди-сюди — KAMA майже не рухається.

> **Для початківця:** уявіть KAMA як "розумну лінію тренду", яка
> йде за ціною, але не смикається від кожного дрібного коливання.
        """
    )

    # ------------------------------------------------------------------
    # 3. Buy rules
    # ------------------------------------------------------------------
    st.header("3. Коли купуємо? (Сигнал на вхід)")
    st.markdown(
        f"""
Акція потрапляє в портфель, якщо виконуються **обидві** умови одночасно:

1. **KAMA-фільтр:** ціна закриття > KAMA × (1 + {_BUFFER_PCT:.0f}%)
   — тобто акція впевнено вище свого тренду з буфером.
2. **Позитивний моментум:** дохідність за останні `{LOOKBACK_PERIOD}` днів
   (приблизно 6 місяців) має бути додатною.

З усіх кандидатів ми обираємо **Топ-{TOP_N}** за силою моментуму
і розподіляємо капітал порівну (~{100 / TOP_N:.0f}% на кожну позицію).

**Приклад:** якщо 150 акцій пройшли KAMA-фільтр, ми ранжуємо їх за
6-місячною дохідністю і беремо лише {TOP_N} найкращих.
        """
    )

    # ------------------------------------------------------------------
    # 4. Sell rules
    # ------------------------------------------------------------------
    st.header("4. Коли продаємо? (Сигнал на вихід)")
    st.markdown(
        f"""
Є **два** типи продажів:

**А) Індивідуальний стоп-лосс KAMA (Lazy Hold):**
- Позиція продається, коли ціна закриття акції падає нижче
  KAMA × (1 − {_BUFFER_PCT:.0f}%).
- Важливо: ми **НЕ** продаємо акцію лише тому, що вона випала
  з Топ-{TOP_N} за моментумом. Поки її власний тренд тримається —
  ми тримаємо позицію.

**Б) Ведмежий режим ринку (Market Regime):**
- Якщо SPY (ETF на індекс S&P 500) падає нижче своєї KAMA на
  {_BUFFER_PCT:.0f}% — весь портфель переходить у кеш.
- Повернення в ринок відбувається лише коли SPY знову піднімається
  вище KAMA на {_BUFFER_PCT:.0f}%.

> **Для початківця:** думайте про це як про два рівні захисту.
> Перший — індивідуальний для кожної акції. Другий — глобальний
> "вимикач", коли падає весь ринок.
        """
    )

    # ------------------------------------------------------------------
    # 5. Three risk management pillars
    # ------------------------------------------------------------------
    st.header("5. Три стовпи управління ризиком")

    col1, col2, col3 = st.columns(3)

    with col1:
        st.subheader("Гістерезис")
        st.markdown(
            f"""
**"Дихання ринку"**

SPY повинен перетнути KAMA
на ±{_BUFFER_PCT:.0f}%, щоб
змінити режим (бик/ведмідь).

**Навіщо?** Без буфера
стратегія би щодня
перемикалася туди-сюди
у боковому ринку, втрачаючи
гроші на комісіях.

**Аналогія:** як термостат з
допуском — він не вмикає
обігрів при кожному коливанні
температури на 0.1°.
            """
        )

    with col2:
        st.subheader("Lazy Hold")
        st.markdown(
            f"""
**"Лінивий" стоп-лосс**

Позиції тримаються, поки
їхній ВЛАСНИЙ тренд
(ціна > KAMA) тримається.

**Навіщо?** Якщо акція
впала з рангу №5 на ранг №30,
але все ще зростає —
продавати її немає сенсу.

**Аналогія:** ви не звільняєте
працівника лише тому, що він
вже не найкращий у рейтингу,
якщо він все ще добре працює.
            """
        )

    with col3:
        st.subheader("Slot Sizing")
        st.markdown(
            f"""
**Суворий розмір позиції**

Кожна позиція — максимум
1/{TOP_N} від портфеля
(~{100 / TOP_N:.0f}%).

**Навіщо?** Навіть якщо
лише 1 акція пройшла
фільтр — вона отримає
лише {100 / TOP_N:.0f}%, а не
весь капітал. Решта — у кеші.

**Аналогія:** не кладіть усі
яйця в один кошик, навіть
якщо цей кошик виглядає
надійним.
            """
        )

    # ------------------------------------------------------------------
    # 6. Parameters table
    # ------------------------------------------------------------------
    st.header("6. Параметри стратегії")
    st.info(
        "Всі параметри зафіксовані. Жодної оптимізації чи підгонки "
        "під історичні дані."
    )

    st.table(
        {
            "Параметр": [
                "Початковий капітал",
                "Комісія за угоду",
                "Прослизання (slippage)",
                "Період KAMA",
                "Період моментуму",
                "Кількість позицій",
                "Буфер KAMA (гістерезис)",
                "Безризикова ставка",
            ],
            "Значення": [
                f"${INITIAL_CAPITAL:,.0f}",
                f"{COMMISSION_RATE:.1%}",
                f"{SLIPPAGE_RATE:.2%} ({SLIPPAGE_RATE * 10_000:.0f} bps)",
                f"{KAMA_PERIOD} днів",
                f"{LOOKBACK_PERIOD} днів (~6 місяців)",
                f"{TOP_N} акцій",
                f"±{_BUFFER_PCT:.0f}%",
                f"{RISK_FREE_RATE:.0%} річних",
            ],
            "Пояснення": [
                "Сума, з якою стартує симуляція",
                "Витрати брокера на кожну операцію купівлі/продажу",
                "Різниця між очікуваною і реальною ціною виконання",
                "Вікно для розрахунку адаптивної ковзної середньої",
                "За який період оцінюємо швидкість зростання акції",
                "Максимум акцій у портфелі одночасно",
                "Захист від хибних перемикань режиму бик/ведмідь",
                "Для розрахунку коефіцієнта Шарпа",
            ],
        }
    )

    # ------------------------------------------------------------------
    # 7. Execution model
    # ------------------------------------------------------------------
    st.header("7. Як виконуються угоди?")
    st.markdown(
        """
| Крок | Час | Дія |
|------|-----|-----|
| 1 | Закриття дня T | Аналізуємо сигнали: KAMA, моментум, режим ринку |
| 2 | Відкриття дня T+1 | Виконуємо угоди за ціною відкриття |
| 3 | Закриття дня T+1 | Переоцінка портфеля (mark-to-market) |

> **Чому не на закритті?** Сигнали формуються на закритті, але торгувати
> за тією ж ціною неможливо в реальності. Виконання на відкритті наступного
> дня — це більш реалістична модель, яка враховує затримку між аналізом
> і виконанням.
        """
    )

    # ------------------------------------------------------------------
    # 8. Advantages
    # ------------------------------------------------------------------
    st.header("8. Переваги підходу")
    st.markdown(
        f"""
**Чому ця стратегія краща за наївний "купи і тримай"?**

- **Захист від великих просадок.** У ведмежому ринку портфель
  переходить у кеш. Це особливо цінно під час криз (2008, 2020, 2022),
  коли "купи і тримай" втрачає 30-50% вартості.

- **Адаптивність KAMA.** На відміну від простої ковзної середньої,
  KAMA автоматично підлаштовується під волатильність ринку. У спокійному
  тренді вона тісно слідує за ціною; у "шумному" ринку — згладжує хибні
  сигнали.

- **Моментум працює.** Академічні дослідження (Jegadeesh & Titman, 1993)
  підтверджують, що акції-переможці продовжують зростати у
  короткостроковій перспективі. Цей ефект спостерігається на ринках
  по всьому світу вже понад 30 років.

- **Без оптимізації = менше підгонки.** Всі параметри зафіксовані
  заздалегідь. Це знижує ризик того, що стратегія "працює лише на
  історії", але провалюється в реальності (проблема overfitting).

- **Реалістичні витрати.** Комісія ({COMMISSION_RATE:.1%}) та
  прослизання ({SLIPPAGE_RATE:.2%}) враховані в кожній угоді.
  Багато "прибуткових" стратегій розсипаються, коли додати реальні
  витрати — наша вже їх включає.

- **Диверсифікація.** {TOP_N} позицій по ~{100 / TOP_N:.0f}% кожна —
  жодна акція не може "знищити" портфель. Навіть якщо одна акція
  впаде на 50%, портфель втратить лише ~{100 / TOP_N / 2:.1f}%.

- **Lazy Hold зменшує оборот.** Ми не перетасовуємо портфель щодня,
  а продаємо лише коли тренд зламався. Менше угод = менше комісій =
  більший чистий прибуток.
        """
    )

    # ------------------------------------------------------------------
    # 9. Glossary
    # ------------------------------------------------------------------
    with st.expander("Словник термінів для початківців"):
        st.markdown(
            f"""
- **Моментум** — тенденція акцій, що зростали нещодавно,
  продовжувати зростання.
- **KAMA** — адаптивна ковзна середня, що реагує на силу тренду.
  Розроблена Перрі Кауфманом.
- **Гістерезис** — буфер, що запобігає частим хибним перемиканням.
  Використовується в техніці, фізиці та фінансах.
- **Просадка (drawdown)** — максимальне падіння вартості портфеля
  від піку до дна. Наприклад, якщо портфель зріс до $15,000,
  а потім впав до $12,000 — просадка = 20%.
- **Коефіцієнт Шарпа (Sharpe Ratio)** — міра дохідності з
  урахуванням ризику. Показує скільки додаткової дохідності
  (понад безризикову ставку {RISK_FREE_RATE:.0%}) ви отримуєте
  на кожну одиницю ризику. Чим вищий — тим краще. Значення > 1
  вважається хорошим.
- **Calmar Ratio** — відношення річної дохідності до максимальної
  просадки. Показує скільки прибутку ви отримуєте на кожен відсоток
  "болю" від падіння.
- **CAGR** — середньорічна дохідність (Compound Annual Growth Rate).
  Враховує складний відсоток.
- **Long/Cash** — стратегія, що або тримає акції (long), або кеш.
  Ніколи не "шортить" (не грає на зниження).
- **Mark-to-market** — переоцінка портфеля за поточними ринковими
  цінами наприкінці кожного торгового дня.
- **Слот (slot)** — одна з {TOP_N} позицій у портфелі.
- **S&P 500** — індекс 500 найбільших публічних компаній США.
  Вважається основним барометром американського фондового ринку.
- **SPY** — ETF (біржовий фонд), що відтворює індекс S&P 500.
  Використовується як бенчмарк (еталон) для порівняння.
            """
        )


page()
