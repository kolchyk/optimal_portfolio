"""Strategy rules explanation page (Ukrainian, beginner-friendly)."""

from collections import Counter

import streamlit as st

from src.portfolio_sim.config import (
    ASSET_CLASS_MAP,
    COMMISSION_RATE,
    CORRELATION_LOOKBACK,
    CORRELATION_THRESHOLD,
    ETF_UNIVERSE,
    INITIAL_CAPITAL,
    KAMA_BUFFER,
    KAMA_PERIOD,
    LOOKBACK_PERIOD,
    RISK_FREE_RATE,
    SLIPPAGE_RATE,
    TOP_N,
    VOLATILITY_LOOKBACK,
)
from src.portfolio_sim.optimizer import PARAM_NAMES, SENSITIVITY_GRID

_BUFFER_PCT = KAMA_BUFFER * 100
_N_ETF = len(ETF_UNIVERSE)
_ASSET_CLASS_COUNTS = Counter(ASSET_CLASS_MAP.values())
_N_ASSET_CLASSES = len(_ASSET_CLASS_COUNTS)
_CORR_PCT = CORRELATION_THRESHOLD * 100
_N_SENSITIVITY = 1
for v in SENSITIVITY_GRID.values():
    _N_SENSITIVITY *= len(v)


def page():
    st.title("Правила стратегії KAMA Momentum")
    st.caption(
        "Long/Cash | Cross-Asset ETF | "
        "Рівна вага або Risk Parity | Щоденний перегляд KAMA"
    )

    # ------------------------------------------------------------------
    # 1. Overview
    # ------------------------------------------------------------------
    st.header("1. Що це за стратегія?")
    st.markdown(
        """
Це **систематична моментум-стратегія**, яка слідує за чіткими
математичними правилами. Вона не намагається "вгадати" ринок,
а купує активи, які зростають найшвидше, і тримає їх, поки тренд
не зламається.

**Простими словами:** ми купуємо те, що зростає, і продаємо те,
що падає. Коли ринок стає небезпечним — виходимо в кеш і чекаємо.

**Тип стратегії:** Long/Cash — ми або тримаємо активи, або готівку.
Ніколи не "шортимо" (не граємо на зниження).
        """
    )

    st.info(
        f"**Cross-Asset ETF** — {_N_ETF} активів з {_N_ASSET_CLASSES} класів "
        "(акції, облігації, товари, нерухомість, крипто). "
        "Тактична всепогодна алокація з risk parity та кореляційним фільтром."
    )

    # ------------------------------------------------------------------
    # 2. Asset universe
    # ------------------------------------------------------------------
    st.header("2. Всесвіт активів")

    st.subheader("Cross-Asset ETF")
    st.markdown(
        f"""
**{_N_ETF} активів з {_N_ASSET_CLASSES} класів.**

- Крос-активна диверсифікація
- Режимний фільтр SPY **вимкнений** за замовч.
- Risk Parity (зворотна волатильність)
- Ранжування за ризик-скоригованим моментумом
- Кореляційний фільтр для диверсифікації

> Всепогодний портфель: коли акції падають,
> облігації та золото часто зростають.
        """
    )

    with st.expander("Склад Cross-Asset ETF по класах активів"):
        class_data = sorted(_ASSET_CLASS_COUNTS.items(), key=lambda x: -x[1])
        st.table(
            {
                "Клас активу": [c for c, _ in class_data],
                "Кількість": [n for _, n in class_data],
            }
        )

    st.markdown(
        """
> **Аналогія:** Всесвіт активів — це як збирати олімпійську
> збірну з різних видів: навіть якщо плавець показує слабший
> результат, він робить команду сильнішою завдяки різноманітності.
        """
    )

    # ------------------------------------------------------------------
    # 3. KAMA indicator
    # ------------------------------------------------------------------
    st.header("3. Індикатор KAMA")
    st.markdown(
        f"""
**KAMA** (Kaufman's Adaptive Moving Average) — це адаптивна ковзна
середня, яка автоматично прискорюється в трендових ринках і
сповільнюється у боковиках.

- **Період за замовч.:** `{KAMA_PERIOD}` торгових днів (приблизно 2 тижні)
- **Діапазон на дашборді:** від 5 до 50 днів
- На відміну від звичайної ковзної середньої (SMA або EMA), KAMA менше
  "шумить" у боковому ринку, але швидко реагує на початок тренду.

**Як це працює?** KAMA використовує так званий *Efficiency Ratio* —
відношення чистого руху ціни до сумарної волатильності. Якщо ціна
рухається стабільно в одному напрямку — KAMA швидко слідує за нею.
Якщо ринок "пилить" туди-сюди — KAMA майже не рухається.

> **Для початківця:** уявіть KAMA як "розумну лінію тренду", яка
> йде за ціною, але не смикається від кожного дрібного коливання.
        """
    )

    # ------------------------------------------------------------------
    # 4. Candidate selection pipeline
    # ------------------------------------------------------------------
    st.header("4. Як обираємо активи? (Пайплайн відбору)")

    st.markdown(
        f"""
Актив потрапляє в портфель через чотири послідовні кроки:

**Крок 1 — KAMA-фільтр:**
Ціна закриття > KAMA × (1 + {_BUFFER_PCT:.1f}%) — актив впевнено
вище свого тренду з буфером.

**Крок 2 — Позитивний моментум:**
Дохідність за останні `{LOOKBACK_PERIOD}` днів (приблизно 6 місяців)
має бути додатною. Це відсіює активи, що просто "відскочили", але
загалом в низхідному тренді.
        """
    )

    st.subheader("Крок 3 — Ранжування")
    st.markdown(
        f"""
**Ранжування за ризик-скоригованим моментумом.**

Формула: `score = дохідність / волатильність` (Sharpe-подібний скор)

Цей метод нормалізує дохідність за ризиком. Це критично для
крос-активного портфеля: без нормалізації криптовалюти та акції
emerging markets завжди б перемагали облігації за сирою дохідністю,
але й несли б у рази більший ризик.

> **Аналогія:** уявіть двох бігунів. Перший фінішує за 10 секунд,
> але з рваним темпом і ризиком травми. Другий — за 10.5 секунд,
> але стабільно і надійно. Ризик-скоригований метод обере другого.
        """
    )

    st.subheader("Крок 4 — Кореляційний фільтр (опціональний)")
    st.markdown(
        f"""
**За замовчуванням:** увімкнений.

Жадібний алгоритм диверсифікації працює так:

1. Беремо актив з найвищим рангом → додаємо в кошик.
2. Беремо наступний за рангом: перевіряємо його кореляцію з **кожним**
   активом, що вже в кошику.
3. Якщо кореляція з будь-яким активом > **{_CORR_PCT:.0f}%** —
   **пропускаємо** його. Він занадто схожий на те, що ми вже маємо.
4. Якщо кореляція прийнятна — додаємо до кошика.
5. Повторюємо, поки в кошику не буде {TOP_N} активів.

**Параметри:** вікно `{CORRELATION_LOOKBACK}` днів, поріг
`{CORRELATION_THRESHOLD}`.

> **Аналогія:** це як підбирати команду для квізу — ви хочете не
> п'ять математиків, а математика, історика, фізика, лінгвіста і
> біолога. Навіть якщо другий математик розумніший за біолога —
> команда від нього не стане сильнішою.
        """
    )

    # ------------------------------------------------------------------
    # 5. Sell rules
    # ------------------------------------------------------------------
    st.header("5. Коли продаємо? (Сигнал на вихід)")
    st.markdown(
        f"""
Є **два** типи продажів:

**А) Індивідуальний стоп-лосс KAMA (Lazy Hold):**
- Позиція продається, коли ціна закриття акції падає нижче
  KAMA × (1 − {_BUFFER_PCT:.1f}%).
- Важливо: ми **НЕ** продаємо актив лише тому, що він випав
  з Топ-{TOP_N} за моментумом. Поки його власний тренд тримається —
  ми тримаємо позицію.

**Б) Ведмежий режим ринку (Market Regime Filter):**
- Якщо SPY (ETF на індекс S&P 500) падає нижче своєї KAMA на
  {_BUFFER_PCT:.1f}% — весь портфель переходить у кеш.
- Повернення в ринок відбувається лише коли SPY знову піднімається
  вище KAMA на {_BUFFER_PCT:.1f}%.

> **Для початківця:** думайте про це як про два рівні захисту.
> Перший — індивідуальний для кожного активу. Другий — глобальний
> "вимикач", коли падає весь ринок.
        """
    )

    st.info(
        "**Режимний фільтр опціональний.** У режимі ETF Cross-Asset він "
        "вимкнений за замовчуванням, бо облігації, золото та інші "
        "некорельовані активи природно хеджують падіння акцій. "
        "Увімкнути його можна на дашборді."
    )

    # ------------------------------------------------------------------
    # 6. Risk management — 4 pillars (2×2 grid)
    # ------------------------------------------------------------------
    st.header("6. Чотири стовпи управління ризиком")

    row1_c1, row1_c2 = st.columns(2)
    row2_c1, row2_c2 = st.columns(2)

    with row1_c1:
        st.subheader("Гістерезис")
        st.markdown(
            f"""
**"Дихання ринку"**

SPY повинен перетнути KAMA на ±{_BUFFER_PCT:.1f}%, щоб змінити
режим (бик/ведмідь).

**Навіщо?** Без буфера стратегія би щодня перемикалася туди-сюди
у боковому ринку, втрачаючи гроші на комісіях.

**Аналогія:** як термостат з допуском — він не вмикає обігрів
при кожному коливанні температури на 0.1°.
            """
        )

    with row1_c2:
        st.subheader("Lazy Hold")
        st.markdown(
            f"""
**"Лінивий" стоп-лосс**

Позиції тримаються, поки їхній ВЛАСНИЙ тренд (ціна > KAMA)
тримається.

**Навіщо?** Якщо актив впав з рангу №5 на ранг №30, але все ще
зростає — продавати його немає сенсу.

**Аналогія:** ви не звільняєте працівника лише тому, що він вже не
найкращий у рейтингу, якщо він все ще добре працює.
            """
        )

    with row2_c1:
        st.subheader("Розмір позицій")
        st.markdown(
            f"""
**Два режими:**

**Equal Weight**: кожна позиція — строго
1/{TOP_N} від портфеля (~{100 / TOP_N:.0f}%). Навіть якщо лише 1
актив пройшов фільтр — він отримає лише {100 / TOP_N:.0f}%, а не
весь капітал.

**Risk Parity** (ETF за замовч.): вага ∝ 1/волатильність. Спокійні
активи (облігації) отримують більше капіталу, волатильні (крипто) —
менше. Вікно для розрахунку: `{VOLATILITY_LOOKBACK}` днів.

> **Аналогія:** уявіть стакани різного розміру. В маленький
> (облігації) — менше ризику, більше грошей. У великий (крипто) —
> більше ризику, менше грошей. Кожен "ризикує" однаково.
            """
        )

    with row2_c2:
        st.subheader("Кореляційний фільтр")
        st.markdown(
            f"""
**Не кладемо в портфель два однакових активи**

Перед додаванням кожного нового активу перевіряємо його кореляцію
з тими, що вже в портфелі. Поріг: `{CORRELATION_THRESHOLD}`.

**Навіщо?** Якщо ви тримаєте AAPL і MSFT — вони часто рухаються
разом. Краще замінити другий на GLD або TLT, який рухається
незалежно.

**Аналогія:** не кладіть усі яйця в один кошик, навіть
якщо ці кошики виглядають по-різному, але стоять на одній полиці.

_Детальніше — у секції 4, крок 4._
            """
        )

    # ------------------------------------------------------------------
    # 7. Parameters table
    # ------------------------------------------------------------------
    st.header("7. Параметри стратегії")

    tab_core, tab_adv = st.tabs(["Основні параметри", "Додаткові параметри"])

    with tab_core:
        st.table(
            {
                "Параметр": [
                    "Початковий капітал",
                    "Період KAMA",
                    "Період моментуму",
                    "Кількість позицій (Top N)",
                    "Буфер KAMA (гістерезис)",
                    "Комісія за угоду",
                    "Прослизання (slippage)",
                    "Безризикова ставка",
                ],
                "За замовч.": [
                    f"${INITIAL_CAPITAL:,.0f}",
                    f"{KAMA_PERIOD} днів",
                    f"{LOOKBACK_PERIOD} днів (~6 міс.)",
                    f"{TOP_N} активів",
                    f"±{_BUFFER_PCT:.1f}%",
                    f"{COMMISSION_RATE:.2%} ({COMMISSION_RATE * 10_000:.0f} bps)",
                    f"{SLIPPAGE_RATE:.2%} ({SLIPPAGE_RATE * 10_000:.0f} bps)",
                    f"{RISK_FREE_RATE:.0%} річних",
                ],
                "Діапазон": [
                    "$1,000 – $10,000,000",
                    "5 – 50 днів",
                    "20 – 252 дні",
                    "3 – 50",
                    "0.0% – 5.0%",
                    "(фіксовано)",
                    "(фіксовано)",
                    "(фіксовано)",
                ],
                "Пояснення": [
                    "Сума, з якою стартує симуляція",
                    "Вікно адаптивної ковзної середньої",
                    "За який період оцінюємо швидкість зростання",
                    "Максимум активів у портфелі одночасно",
                    "Захист від хибних перемикань бик/ведмідь",
                    "Витрати брокера на кожну операцію",
                    "Різниця між очікуваною і реальною ціною",
                    "Для розрахунку коефіцієнта Шарпа",
                ],
            }
        )

    with tab_adv:
        st.table(
            {
                "Параметр": [
                    "Ризик-скориг. моментум",
                    "Режимний фільтр SPY",
                    "Кореляційний фільтр",
                    "Поріг кореляції",
                    "Вікно кореляції",
                    "Режим розміру позицій",
                    "Вікно волатильності",
                ],
                "ETF (Cross-Asset)": [
                    "Увімк",
                    "Вимк (опц.)",
                    "Увімк",
                    f"{CORRELATION_THRESHOLD} (0.30 – 0.95)",
                    f"{CORRELATION_LOOKBACK} днів (20 – 120)",
                    "Risk Parity",
                    f"{VOLATILITY_LOOKBACK} днів (10 – 60)",
                ],
                "Пояснення": [
                    "Ранжування за return/volatility замість raw return",
                    "Глобальний kill-switch при падінні ринку",
                    "Жадібна диверсифікація портфеля",
                    "Макс. дозволена парна кореляція між активами",
                    "Дні для обчислення кореляції",
                    "Рівна вага або зворотна волатильність",
                    "Вікно для inverse-vol зважування",
                ],
            }
        )

    st.info(
        "Усі параметри можна змінювати на дашборді через бічну панель. "
        "Значення за замовчуванням не оптимізовані під історичні дані — "
        "вони обрані з міркувань робастності (див. секцію 9)."
    )

    # ------------------------------------------------------------------
    # 8. Execution model
    # ------------------------------------------------------------------
    st.header("8. Як виконуються угоди?")
    st.markdown(
        """
| Крок | Час | Дія |
|------|-----|-----|
| 1 | Закриття дня T | Аналізуємо сигнали: KAMA, моментум, кореляції, режим ринку |
| 2 | Закриття дня T | Обчислюємо ваги (risk parity) або рівні частки (equal weight) |
| 3 | Відкриття дня T+1 | Виконуємо угоди за ціною відкриття |
| 4 | Закриття дня T+1 | Переоцінка портфеля (mark-to-market) |

> **Чому не на закритті?** Сигнали формуються на закритті, але торгувати
> за тією ж ціною неможливо в реальності. Виконання на відкритті наступного
> дня — це більш реалістична модель, яка враховує затримку між аналізом
> і виконанням.
        """
    )

    # ------------------------------------------------------------------
    # 9. Sensitivity analysis
    # ------------------------------------------------------------------
    st.header("9. Аналіз чутливості параметрів")
    st.markdown(
        f"""
**Мета:** не знайти "найкращі" параметри (це шлях до overfitting),
а підтвердити, що обрані дефолти сидять на **плоському плато**
продуктивності.

**Як це працює?** Ми прогоняємо стратегію на сітці з
**{_N_SENSITIVITY}** комбінацій параметрів:
        """
    )

    grid_data = {
        "Параметр": [],
        "Значення у сітці": [],
    }
    for name in PARAM_NAMES:
        grid_data["Параметр"].append(name)
        grid_data["Значення у сітці"].append(
            ", ".join(str(v) for v in SENSITIVITY_GRID[name])
        )
    st.table(grid_data)

    st.markdown(
        f"""
**Цільова функція:** Calmar Ratio (CAGR / Max Drawdown). Комбінації
з максимальною просадкою > 30% відхиляються.

**Robustness Score:** від 0 до 1 для кожного параметра.
- **≥ 0.8** — параметр робастний (результат стабільний)
- **0.5 – 0.8** — помірна чутливість
- **< 0.5** — стратегія крихка відносно цього параметра

> **Аналогія:** це як перевірити, чи тримається будівля не лише
> при ідеальному фундаменті, а й при невеликих відхиленнях.
> Якщо стратегія працює лише при `kama_period=10` і розсипається
> при 15 — вона крихка. Якщо працює при 10, 15, 20, 30 і 40 —
> вона надійна.

Запустити аналіз чутливості: `python run_optimizer.py`
        """
    )

    # ------------------------------------------------------------------
    # 10. Efficient frontier
    # ------------------------------------------------------------------
    st.header("10. Ефективна межа Марковіца")
    st.markdown(
        """
На дашборді є графік **Risk-Return Distribution & Efficient Frontier**.
Що він показує?

**Ефективна межа (Efficient Frontier)** — це набір портфелів, які
пропонують **найвищу дохідність для кожного рівня ризику**. Вона
обчислюється за методом Марковіца (mean-variance optimization).

**Як читати графік:**
- **Кожна точка** — один актив (волатильність по X, дохідність по Y)
- **Золота крива** — ефективна межа
- **Зелена зірка** — позиція вашого портфеля
- **Сірий ромб** — S&P 500 (бенчмарк)

**Інтерпретація:**
- Точка **ВИЩЕ** межі — недосяжна (чудес не буває)
- Точка **НА** межі — оптимальний портфель для цього рівня ризику
- Точка **НИЖЧЕ** межі — є простір для покращення

> **Аналогія:** ефективна межа — це як межа швидкості автомобіля.
> Ви можете їхати повільніше (менше ризику, менше дохідності),
> але не швидше без збільшення ризику. Будь-яка точка вище
> цієї межі — недосяжна.
        """
    )

    # ------------------------------------------------------------------
    # 11. Advantages
    # ------------------------------------------------------------------
    st.header("11. Переваги підходу")
    st.markdown(
        f"""
**Чому ця стратегія краща за наївний "купи і тримай"?**

- **Захист від великих просадок.** У ведмежому ринку портфель
  переходить у кеш або ротує в некорельовані активи
  (ETF режим). Це особливо цінно під час криз (2008, 2020, 2022),
  коли "купи і тримай" втрачає 30-50% вартості.

- **Адаптивність KAMA.** На відміну від простої ковзної середньої,
  KAMA автоматично підлаштовується під волатильність ринку. У спокійному
  тренді вона тісно слідує за ціною; у "шумному" ринку — згладжує хибні
  сигнали.

- **Моментум працює.** Академічні дослідження (Jegadeesh & Titman, 1993)
  підтверджують, що акції-переможці продовжують зростати у
  короткостроковій перспективі. Цей ефект спостерігається на ринках
  по всьому світу вже понад 30 років.

- **Крос-активна диверсифікація.** У режимі ETF портфель включає
  облігації, золото, товари та нерухомість. Ці класи активів часто
  зростають, коли акції падають, створюючи "всепогодний" ефект.

- **Risk Parity вирівнює ризик.** Зворотна волатильність забезпечує,
  що кожна позиція вносить приблизно однаковий ризик у портфель.
  Крипто чи EM-акції не домінуватимуть, навіть якщо їхня дохідність
  найвища.

- **Кореляційний фільтр.** Жадібний алгоритм забезпечує, що портфель
  складається з різноманітних, некорельованих активів. Це зменшує
  ризик одночасного падіння всіх позицій.

- **Параметри перевірені, а не оптимізовані.** Аналіз чутливості
  ({_N_SENSITIVITY} комбінацій) підтверджує, що результати стабільні
  в широкому діапазоні параметрів. Це знижує ризик overfitting.

- **Реалістичні витрати.** Комісія ({COMMISSION_RATE:.2%}) та
  прослизання ({SLIPPAGE_RATE:.2%}) враховані в кожній угоді.
  Багато "прибуткових" стратегій розсипаються, коли додати реальні
  витрати — наша вже їх включає.

- **Lazy Hold зменшує оборот.** Ми не перетасовуємо портфель щодня,
  а продаємо лише коли тренд зламався. Менше угод = менше комісій =
  більший чистий прибуток.

- **Повна конфігурованість.** Усі параметри можна налаштувати через
  дашборд і перевірити результат у реальному часі.
        """
    )

    # ------------------------------------------------------------------
    # 12. Glossary
    # ------------------------------------------------------------------
    with st.expander("Словник термінів для початківців"):
        st.markdown(
            f"""
- **Моментум** — тенденція активів, що зростали нещодавно,
  продовжувати зростання.
- **Ризик-скоригований моментум (Risk-Adjusted Momentum)** —
  ранжування за return/volatility замість сирої дохідності.
  Перевага: нормалізує активи з різним рівнем ризику.
- **KAMA** — адаптивна ковзна середня, що реагує на силу тренду.
  Розроблена Перрі Кауфманом.
- **Гістерезис** — буфер, що запобігає частим хибним перемиканням.
  Використовується в техніці, фізиці та фінансах.
- **Кореляція** — міра того, наскільки два активи рухаються разом.
  Від −1 (повна протилежність) до +1 (повний збіг). Поріг {CORRELATION_THRESHOLD}
  означає "занадто схожі".
- **Кореляційний фільтр** — жадібний алгоритм, що пропускає активи,
  надто корельовані з тими, що вже в портфелі. Забезпечує диверсифікацію.
- **Risk Parity (Паритет ризику)** — метод зважування, де кожен
  актив вносить приблизно однаковий ризик у портфель.
- **Inverse Volatility (Зворотна волатильність)** — зважування
  пропорційно 1/волатильність. Спокійні активи отримують більше
  капіталу.
- **Просадка (Drawdown)** — максимальне падіння вартості портфеля
  від піку до дна. Наприклад, якщо портфель зріс до $15,000,
  а потім впав до $12,000 — просадка = 20%.
- **Коефіцієнт Шарпа (Sharpe Ratio)** — міра дохідності з
  урахуванням ризику. Показує скільки додаткової дохідності
  (понад безризикову ставку {RISK_FREE_RATE:.0%}) ви отримуєте
  на кожну одиницю ризику. Чим вищий — тим краще. > 1 вважається
  хорошим.
- **Calmar Ratio** — відношення річної дохідності до максимальної
  просадки. Показує скільки прибутку ви отримуєте на кожен відсоток
  "болю" від падіння. Використовується як цільова функція в аналізі
  чутливості.
- **CAGR** — середньорічна дохідність (Compound Annual Growth Rate).
  Враховує складний відсоток.
- **Ефективна межа (Efficient Frontier)** — крива Марковіца, що
  показує оптимальні портфелі для кожного рівня ризику. Побудована
  методом mean-variance optimization.
- **Аналіз чутливості (Sensitivity Analysis)** — перевірка стратегії
  на {_N_SENSITIVITY} комбінаціях параметрів. Мета: підтвердити
  робастність, а не знайти "найкраще".
- **Робастність** — здатність стратегії показувати стабільні
  результати при зміні параметрів. Протилежність overfitting.
- **Long/Cash** — стратегія, що або тримає активи (long), або кеш.
  Ніколи не "шортить" (не грає на зниження).
- **Mark-to-market** — переоцінка портфеля за поточними ринковими
  цінами наприкінці кожного торгового дня.
- **ETF (Exchange-Traded Fund)** — біржовий фонд, що торгується
  як звичайна акція. Дозволяє інвестувати в цілий клас активів
  (наприклад, GLD — золото, TLT — довгі облігації).
- **ADR (American Depositary Receipt)** — "розписка" на іноземну
  акцію, що торгується на американській біржі. Дозволяє купувати
  акції компаній з інших країн без виходу на іноземні біржі.
- **All-Weather (Всепогодний портфель)** — концепція портфеля,
  що включає різні класи активів для захисту в будь-яких ринкових
  умовах. Популяризована Реєм Даліо (Bridgewater).
- **Слот (Slot)** — одна з {TOP_N} позицій у портфелі.
- **S&P 500** — індекс 500 найбільших публічних компаній США.
  Вважається основним барометром американського фондового ринку.
- **SPY** — ETF, що відтворює індекс S&P 500. Використовується
  як бенчмарк та вхід для режимного фільтра.
            """
        )


page()
