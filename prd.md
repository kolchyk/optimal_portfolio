# PRD: Portfolio Investment Module v2

## PRD-PSIM-001 | Полная спецификация для реализации с нуля

---

## 1. Обзор проекта

### 1.1 Что строим

Модуль количественного портфельного инвестирования (`src/portfolio_sim/`), который:
- Отбирает акции из вселенной ~600 тикеров на основе моментум-сигналов
- Управляет риском через институциональные фильтры (Market Breadth, KAMA trailing stops)
- Валидирует производительность через Walk-Forward Validation
- Работает как CLI-утилита с будущей интеграцией в Streamlit UI

### 1.2 Зачем перестраивать

По результатам экспертного аудита текущей реализации выявлены проблемы:

1. **Избыточная параметризация**: 9 настраиваемых параметров создают высокий риск переобучения (overfitting). TMA-сглаживание, бленд периодов моментума и dampener — это "математические костыли" (Tier 4), которые должны быть удалены.
2. **Нет простого бейзлайна**: Отсутствует эталонная "простая" стратегия. Невозможно определить, добавляет ли сложность реальную альфу.
3. **Неверное позиционирование оптимизации**: WFV должен быть **единственным** продакшн-режимом.

### 1.3 Философия: Бритва Оккама

> Если сложная модель дает `CAGR 18% / MaxDD 12%`, а простая (без лишних параметров) дает `CAGR 16% / MaxDD 14%` — **выбирай простую**. Меньше настраиваемых деталей — меньше точек отказа при торговле реальными деньгами.

### 1.4 Критерии успеха

- Простая бейзлайн-стратегия достигает положительного OOS Calmar ratio по окнам WFV
- Простая стратегия использует максимум 4 настраиваемых параметра
- WFV — режим по умолчанию для продакшн-валидации
- Покрытие тестами не менее 80%

---

## 2. Иерархия фичей по важности (Feature Tiers)

### Tier 1: Выживание и защита капитала (60% успеха — ФУНДАМЕНТ)

| # | Фича | Описание | Почему критична |
|---|---|---|---|
| 1 | **Market Breadth Filter + SHV** | Глобальный "рубильник": если < 30% тикеров выше KAMA → 100% в кэш (SHV) | Никакая математика отбора акций не спасет, если S&P 500 летит в пропасть |
| 2 | **Индивидуальный KAMA-фильтр** | Жесткое правило: `Price > KAMA` для удержания позиции. Trailing stop на уровне KAMA | Обрезает "падающие ножи", не дает портфелю пересиживать глубокие убытки |

### Tier 2: Генерация альфы и управление риском (30% успеха — ДВИГАТЕЛЬ)

| # | Фича | Описание | Почему важна |
|---|---|---|---|
| 3 | **Cross-Sectional Momentum** | Ранжирование по сырой доходности за 6 месяцев (`Close / Close_126d - 1`) | Сердце доходности: капитал перетекает в сильные активы |
| 4 | **Inverse Volatility Weighting** | Взвешивание `1 / vol`: выравнивает влияние каждой акции на портфельный риск | Без этого волатильные активы определяют весь риск портфеля |

### Tier 3: Защита от скрытых рисков (10% успеха — ТОНКАЯ НАСТРОЙКА)

| # | Фича | Описание | Почему нужна |
|---|---|---|---|
| 5 | **Correlation Constraint** | Ограничение `max_correlation` между позициями в портфеле | Защита от избыточной концентрации в одном секторе |

### Tier 4: УДАЛЕНО (высокий риск переобучения)

*Данные фичи признаны вредными для долгосрочной устойчивости и полностью исключены из плана реализации:*
- TMA Smoothing (запаздывание сигналов)
- Бленд периодов моментума (лишние степени свободы)
- Momentum Dampener (заменен на жесткий `vol_floor = 0.05`)

---

## 3. Архитектура

### 3.1 Структура модуля

```
src/portfolio_sim/
    __init__.py
    config.py              -- Типизированные конфигурации (dataclasses), константы
    alpha.py               -- Simple Baseline стратегия (ПРОДАКШН)
    engine.py              -- Движок симуляции (сигналы на Close, исполнение на Open)
    optimization.py        -- Интеграция с Optuna (WFV)
    walk_forward.py        -- Walk-Forward Validation оркестратор
    data.py                -- Загрузка тикеров, fetching, Parquet-кэширование
    reporting.py           -- Метрики, графики, Markdown/JSON отчеты

run_portfolio_sim.py       -- CLI entry point
portfolio_tickers.json     -- Вселенная тикеров
```

### 3.2 Поток данных

```
portfolio_tickers.json
        │
        ▼
    data.py ──► MarketDataFetcher.fetch_ohlcv_batch()
        │
        ▼
    Parquet cache (Close + Open DataFrames)
        │
        ▼
    walk_forward.py (оркестрирует скользящие окна)
        │
        ├──► optimization.py (Optuna на каждом окне)
        │        │
        │        └──► engine.py (bar-by-bar симуляция)
        │                │
        │                ├──► alpha.py (вычисление целевых весов)
        │                └──► KAMA индикатор (src/business/indicators/kama.py)
        ▼
    reporting.py ──► Markdown, JSON, PNG выходные файлы
```

### 3.3 Ключевые архитектурные решения

**1. Strategy-agnostic Engine.** Движок принимает параметры и вызывает логику `alpha.py`.

**2. Типизированная конфигурация.** Использование dataclasses для всех параметров.

**3. structlog.** Структурное логирование для мониторинга WFV.

---

## 4. Стратегия: Simple Baseline (`alpha.py`)

#### Алгоритм (5 шагов):

**Шаг 1: Глобальный фильтр — Market Breadth + SHV**
```
breadth = count(Close[t] > KAMA[t]) / total_valid_tickers
Если breadth < BREADTH_THRESHOLD (0.30):
    → 100% в SHV.
```

**Шаг 2: Фильтр тренда — Close > KAMA**
```
Для каждого тикера:
    Если Close[-1] > KAMA[-1]: оставить в кандидатах
```

**Шаг 3: Ранжирование — Сырой 6-месячный моментум**
```
score[t] = Close[-1] / Close[-lookback_period] - 1
```

**Шаг 4: Диверсификация — Correlation Walk-down**
```
Greedy selection с проверкой корреляции < max_correlation.
```

**Шаг 5: Взвешивание — Inverse Volatility**
```
weight[t] ~ 1 / annualized_std(returns[-20:])
Кэппинг MAX_WEIGHT (15%). Остаток в SHV.
```

#### Настраиваемые параметры (4):

| Параметр | Дефолт | Мин | Макс | Шаг |
|---|---|---|---|---|
| `kama_period` | 20 | 10 | 40 | 10 |
| `lookback_period` | 126 | 63 | 126 | 21 |
| `max_correlation` | 0.70 | 0.5 | 0.9 | 0.1 |
| `top_n_selection` | 15 | 10 | 25 | 5 |

---

## 5. Движок симуляции (`engine.py`)

### 5.1 Принцип: Сигналы на Close(T) → Исполнение на Open(T+1)

### 5.2 Модель издержек

| Издержка | Значение |
|---|---|
| `COMMISSION_RATE` | 0.001 (0.1%) |
| `SLIPPAGE_RATE` | 0.0015 (15 bps) |
| **Итого** | **0.25% на сделку** |

---

## 6. Валидация: Walk-Forward Validation

> **WFV — единственный режим для продакшн-оценки.**

### 6.1 Дизайн окон

| Параметр | Значение | Описание |
|---|---|---|
| `WFV_TRAIN_DAYS` | 252 | 1 год тренировки |
| `WFV_TEST_DAYS` | 63 | 1 квартал теста (OOS) |

### 6.2 Целевая функция

Максимизация **Calmar Ratio** (CAGR / MaxDD) со штрафом за просадку > 25%.

---

## 7. Reporting & CLI

### 7.1 Ключевые метрики
- CAGR, MaxDD, Sharpe, Calmar.
- WFV Win Rate (% удачных окон).
- Annualized Turnover (оборачиваемость).

### 7.2 CLI Интерфейс
```
python run_portfolio_sim.py --walk-forward --n-trials 100
```

---

## 8. Последовательность реализации

### Фаза 1: Фундамент
1. `config.py` (Typed dataclasses)
2. `data.py` (Fetch & Cache)

### Фаза 2: Alpha & Engine
3. `alpha.py` (Simple Baseline)
4. `engine.py` (Bar-by-bar sim)

### Фаза 3: Валидация & Отчеты
5. `optimization.py` & `walk_forward.py`
6. `reporting.py` (Метрики и графики)
7. CLI entry point

---

## 9. Зависимости
- `kama.py` (Numba JIT)
- `fetch_service.py` (yfinance/Twelve Data)
- `structlog`
- `optuna`

---
**КОНЕЦ СПЕЦИФИКАЦИИ**
