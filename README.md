# Optimal Portfolio — KAMA Momentum Strategy

Систематическая моментум-стратегия с адаптивной скользящей средней Кауфмана (KAMA),
Walk-Forward оптимизацией параметров и кросс-активной аллокацией.

**Тип стратегии:** Long/Cash — покупаем растущие активы, выходим в кэш при развороте.
Без шортов.

## Содержание

- [Вселенная активов](#вселенная-активов)
- [Пайплайн поиска оптимального портфеля](#пайплайн-поиска-оптимального-портфеля)
- [Алгоритмы отбора активов](#алгоритмы-отбора-активов)
- [Параметры стратегии](#параметры-стратегии)
- [Метрики производительности](#метрики-производительности)
- [Использование](#использование)
- [Технологический стек](#технологический-стек)

---

## Вселенная активов

140+ тикеров из 8 классов активов (тактическая всепогодная аллокация):

| Класс актива | Кол-во | Примеры |
|---|---|---|
| US Equities | 50 | AAPL, MSFT, NVDA, GOOGL, AMZN |
| International Equities (ADR) | 17 | ASML, TSM, SAP, SHEL |
| Emerging Markets (ADR) | 20 | BABA, MELI, VALE, PDD |
| US Sector & Thematic ETFs | 21 | QQQ, XLK, SMH, XLE, IBB |
| International & Regional ETFs | 20 | VEA, EEM, VGK, EWJ |
| Bonds & Fixed Income | 20 | TLT, IEF, LQD, HYG, EMB |
| Metals | 7 | GLD, SLV, CPER, LIT |
| Real Estate & REITs | 20 | VNQ, SCHH, RWR, VNQI |
| Crypto ETFs | 5 | IBIT, FBTC, ETHA |

Бенчмарк: **S&P 500 (SPY)** — buy-and-hold.

---

## Пайплайн поиска оптимального портфеля

Полная последовательность — от загрузки данных до итоговых параметров:

```
1. Загрузка данных (yfinance → Parquet-кэш)
   ↓
2. Расчёт индикаторов (KAMA, Efficiency Ratio)
   ↓
3. Генерация WFO-расписания (скользящие окна IS/OOS)
   ↓
4. Для каждого WFO-шага:
   ├─ 4a. Оптимизация на IS-данных (Optuna TPE → лучший Sharpe)
   ├─ 4b. Симуляция на IS с лучшими параметрами
   └─ 4c. Валидация на OOS (параметры НЕ оптимизированы на OOS)
   ↓
5. Сшивка OOS-эквити → агрегированная производительность
   ↓
6. Итоговые параметры (из последнего IS-окна)
```

### Шаг 1. Загрузка и кэширование данных

- **Источник:** Yahoo Finance (yfinance) — дневные OHLCV
- **Кэш:** `output/cache/close_prices_etf.parquet`, `open_prices_etf.parquet`
- Загрузка батчами по 100 тикеров, auto-adjust для сплитов/дивидендов
- При повторных запусках данные берутся из кэша (флаг `--refresh` для перезагрузки)
- Фильтрация тикеров с недостаточной историей (< lookback_period дней)

### Шаг 2. Расчёт индикаторов

**KAMA (Kaufman's Adaptive Moving Average)** — вычисляется для всех тикеров и периодов
параллельно (ProcessPoolExecutor). Результаты кэшируются в памяти и переиспользуются
во всех Optuna-триалах.

**Efficiency Ratio (ER)** — вычисляется одновременно с KAMA, используется для
ER²-скорректированного ранжирования моментума.

Оба индикатора ускорены через **Numba JIT** (cache=True).

### Шаг 3. Walk-Forward расписание

Скользящие окна с фиксированной шириной:

- **In-Sample (IS):** 756 дней (≈3 года) — обучение параметров
- **Out-of-Sample (OOS):** 252 дня (≈1 год) — валидация
- Окна сдвигаются на OOS-ширину каждый шаг

```
|-------- IS (3 года) --------|- OOS (1 год) -|
                    |-------- IS (3 года) --------|- OOS (1 год) -|
                                         ...
```

### Шаг 4a. Оптимизация параметров (Optuna)

На каждом IS-окне запускается байесовская оптимизация:

- **Семплер:** TPE (Tree-structured Parzen Estimator)
- **Триалов:** 150 (по умолчанию)
- **Целевая функция:** Sharpe Ratio (максимизация)
- **Ограничения:** max drawdown ≤ 30%, min 60 торговых дней, return > 0
- **Параллелизм:** ProcessPoolExecutor, батчевая отправка триалов

Первый триал всегда использует базовые параметры как baseline.

### Шаг 4b–4c. Симуляция и валидация

**In-Sample:** симуляция с оптимальными параметрами → IS-метрики (CAGR, Max DD).

**Out-of-Sample:** те же параметры на данных, **невидимых** при оптимизации.
Добавляется warmup-префикс для корректного расчёта индикаторов.
Эквити обрезается до OOS-периода.

### Шаг 5. Сшивка OOS-эквити

OOS-кривые всех шагов конкатенируются хронологически. Каждый следующий сегмент
масштабируется так, чтобы начинаться с конечной точки предыдущего. Результат —
агрегированная OOS-производительность стратегии.

### Шаг 6. Итоговые параметры

Параметры последнего IS-окна рекомендуются для live-торговли.
Деградация IS→OOS анализируется: если OOS CAGR < 50% от IS CAGR — предупреждение
о возможном переобучении.

---

## Алгоритмы отбора активов

### KAMA (Kaufman's Adaptive Moving Average)

Адаптивная скользящая средняя, которая автоматически подстраивается под рыночный режим:

```
ER = |close[i] - close[i-period]| / Σ|close[j] - close[j-1]|
SC = (ER × (fast - slow) + slow)²
KAMA[i] = KAMA[i-1] + SC × (close[i] - KAMA[i-1])
```

- В тренде (высокий ER) → быстрая реакция
- В боковике (низкий ER) → почти не двигается
- Параметры: `period=40`, `fast=2`, `slow=30`

### Efficiency Ratio (ER)

Измеряет «гладкость» тренда:

```
ER = |чистое движение за period| / Σ|дневных изменений за period|
```

- ER = 1.0 — идеально гладкий тренд
- ER = 0.0 — хаотичное движение (шум)
- Диапазон: [0, 1], обрезается

### Трёхэтапный отбор кандидатов

**Этап 1 — KAMA-фильтр:**

```
Close > KAMA × (1 + kama_buffer)
```

Актив должен быть уверенно выше своей адаптивной средней (с буфером-гистерезисом).

**Этап 2 — Моментум-ранжирование (ER²-скорректированное):**

```
momentum = close_now / close_lookback_ago - 1
score = momentum × ER²
```

ER² жёстко штрафует хаотичное движение:

| ER | ER² | Эффект |
|---|---|---|
| 0.8 (гладкий тренд) | 0.64 | Сохраняет 64% моментума |
| 0.5 (средний) | 0.25 | Срезает 75% |
| 0.3 (хаотичный) | 0.09 | Почти обнуляет скор |

Кандидаты ранжируются по убыванию score, отбираются Top-N.

**Этап 3 — Корреляционный фильтр:**

Перед покупкой каждого кандидата проверяется попарная корреляция Пирсона
с уже удерживаемыми позициями (по дневной доходности за lookback_period дней).
Если корреляция > `corr_threshold` — кандидат пропускается.

### Правила входа и выхода

**Вход:** сигналы формируются на Close(T), исполнение на Open(T+1).

**Выход (Lazy Hold):** позиция продаётся **только** когда её собственный тренд ломается:

```
Close < KAMA × (1 - kama_buffer)
```

Позиция **не** продаётся из-за падения в рейтинге моментума. Пока индивидуальный
KAMA-стоп не сработал — держим. Это снижает оборачиваемость и комиссионные расходы.

### Размер позиций — Risk Parity (обратная волатильность)

```
weight[i] = (1/vol[i]) / Σ(1/vol[j])
```

Спокойные активы (облигации) получают больше капитала, волатильные (крипто) — меньше.
Волатильность = rolling std доходностей за `volatility_lookback` дней (по умолчанию 20).

---

## Параметры стратегии

### Основные параметры

| Параметр | По умолч. | Диапазон оптимизации | Описание |
|---|---|---|---|
| `kama_period` | 40 | 10, 20, 30 | Период адаптивной скользящей средней |
| `lookback_period` | 40 | 20–100 (шаг 20) | Период расчёта моментума |
| `top_n` | 25 | 5–30 (шаг 5) | Максимум позиций в портфеле |
| `kama_buffer` | 0.01 (1%) | 0.005–0.03 (шаг 0.005) | Буфер гистерезиса вокруг KAMA |
| `oos_days` | 20 | 10–40 (шаг 10) | OOS-окно (торговых дней) |
| `corr_threshold` | 0.7 | 0.5–0.95 (шаг 0.05) | Макс. корреляция с удерживаемыми позициями |

### Дополнительные параметры

| Параметр | По умолч. | Описание |
|---|---|---|
| `use_risk_adjusted` | True | ER²-скорректированный моментум |
| `volatility_lookback` | 20 | Окно для inverse-vol взвешивания (Risk Parity) |

### Фиксированные параметры

| Параметр | Значение | Описание |
|---|---|---|
| `INITIAL_CAPITAL` | $10,000 | Стартовый капитал |
| `COMMISSION_RATE` | 0.02% (2 bps) | Комиссия брокера |
| `SLIPPAGE_RATE` | 0.05% (5 bps) | Проскальзывание |
| `RISK_FREE_RATE` | 4% годовых | Для расчёта Sharpe Ratio |

---

## Метрики производительности

| Метрика | Формула | Что показывает |
|---|---|---|
| Total Return | equity_end / equity_start − 1 | Кумулятивная доходность |
| CAGR | (equity_end / equity_start)^(252/days) − 1 | Среднегодовая доходность |
| Max Drawdown | max(peak − trough) / peak | Макс. просадка от пика |
| Sharpe Ratio | (CAGR − risk_free) / ann_vol | Доходность на единицу риска |
| Calmar Ratio | CAGR / max_drawdown | Доходность на единицу просадки |
| Annualized Vol | std(daily_returns) × √252 | Годовая волатильность |
| Win Rate | дней с return > 0 / всего дней | Доля прибыльных дней |

---

## Использование

### CLI: Walk-Forward оптимизация

```bash
# Установка
pip install -e .

# Запуск WFO (параметры по умолчанию)
python -m src.portfolio_sim walk-forward

# С указанием параметров
python -m src.portfolio_sim walk-forward \
    --period 5y \
    --n-trials 200 \
    --n-workers 8 \
    --refresh
```

| Флаг | По умолч. | Описание |
|---|---|---|
| `--period` | 3y | Период данных (формат yfinance: 3y, 5y, 6mo) |
| `--n-trials` | 150 | Кол-во триалов Optuna на каждый IS-шаг |
| `--n-workers` | cpu_count − 1 | Параллельные воркеры |
| `--refresh` | — | Принудительная перезагрузка данных |
| `--oos-days` | 20 | Размер OOS-окна (торговых дней) |

### Результаты

```
output/wfo_YYYYMMDD_HHMMSS/
├── wfo_report.txt             # Сводный отчёт
├── wfo_steps.csv              # Метрики по каждому WFO-шагу
├── stitched_oos_equity.csv    # Дневная OOS-эквити
└── stitched_oos_equity.png    # График эквити (стратегия vs S&P 500)
```

### Streamlit Dashboard

```bash
streamlit run app.py
```

Две страницы:

- **Backtest** — интерактивный бэктест с настройкой параметров через слайдеры
- **Правила стратегії** — документация по стратегии

---

## Технологический стек

| Технология | Назначение |
|---|---|
| **Python 3.12+** | Язык |
| **Numba** | JIT-компиляция KAMA/ER (100x ускорение) |
| **Optuna** | Байесовская оптимизация параметров (TPE) |
| **Pandas / NumPy** | Работа с временными рядами |
| **yfinance** | Загрузка рыночных данных |
| **Streamlit** | Интерактивный дашборд |
| **Parquet** | Кэш данных (быстрый, компактный) |
| **ProcessPoolExecutor** | Параллелизм (обход GIL) |

---

## Структура проекта

```
src/portfolio_sim/
├── cli.py              # CLI-диспетчер
├── config.py           # Параметры, вселенная активов, пространство поиска
├── params.py           # StrategyParams (frozen dataclass)
├── data.py             # Загрузка данных (yfinance + Parquet-кэш)
├── indicators.py       # KAMA и ER (Numba JIT)
├── alpha.py            # Генерация альфа-сигналов (отбор кандидатов)
├── engine.py           # Движок симуляции (bar-by-bar)
├── optimizer.py        # Оптимизация параметров (Optuna)
├── parallel.py         # Параллельные воркеры
├── walk_forward.py     # Walk-Forward оптимизация
├── reporting.py        # Метрики, графики, отчёты
└── commands/
    └── walk_forward.py # CLI-обработчик команды walk-forward
```
