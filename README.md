# Optimal Portfolio — R² Momentum Strategy

Систематическая моментум-стратегия по методологии Андреаса Кленова ("Stocks on the Move"):
R² Momentum scoring, KAMA тренд-фильтры, ATR risk parity sizing, Walk-Forward оптимизация.

**Тип стратегии:** Long/Cash — покупаем активы с сильным, стабильным трендом,
выходим в кэш при развороте. Без шортов.

## Содержание

- [Вселенная активов](#вселенная-активов)
- [Пайплайн поиска оптимального портфеля](#пайплайн-поиска-оптимального-портфеля)
- [Алгоритмы отбора активов](#алгоритмы-отбора-активов)
- [Параметры стратегии](#параметры-стратегии)
- [Метрики производительности](#метрики-производительности)
- [Использование](#использование)
- [Технологический стек](#технологический-стек)

---

## Вселенная активов

140+ тикеров из 8 классов активов (тактическая всепогодная аллокация):

| Класс актива | Кол-во | Примеры |
|---|---|---|
| US Equities | 50 | AAPL, MSFT, NVDA, GOOGL, AMZN |
| International Equities (ADR) | 17 | ASML, TSM, SAP, SHEL |
| Emerging Markets (ADR) | 20 | BABA, MELI, VALE, PDD |
| US Sector & Thematic ETFs | 21 | QQQ, XLK, SMH, XLE, IBB |
| International & Regional ETFs | 20 | VEA, EEM, VGK, EWJ |
| Bonds & Fixed Income | 20 | TLT, IEF, LQD, HYG, EMB |
| Metals | 7 | GLD, SLV, CPER, LIT |
| Real Estate & REITs | 20 | VNQ, SCHH, RWR, VNQI |
| Crypto ETFs | 5 | IBIT, FBTC, ETHA |

Бенчмарк: **S&P 500 (SPY)** — buy-and-hold.

---

## Пайплайн поиска оптимального портфеля

```
1. Загрузка данных (yfinance → Parquet-кэш)
   ↓
2. Расчёт индикаторов (KAMA для тренд-фильтров)
   ↓
3. Генерация WFO-расписания (скользящие окна IS/OOS)
   ↓
4. Для каждого WFO-шага:
   ├─ 4a. Оптимизация на IS-данных (Optuna TPE → макс. CAGR)
   ├─ 4b. Симуляция на IS с лучшими параметрами
   └─ 4c. Валидация на OOS (параметры НЕ оптимизированы на OOS)
   ↓
5. Сшивка OOS-эквити → агрегированная производительность
   ↓
6. Итоговые параметры (из последнего IS-окна)
```

### Шаг 1. Загрузка и кэширование данных

- **Источник:** Yahoo Finance (yfinance) — дневные OHLCV
- **Кэш:** `output/cache/close_prices_etf.parquet`, `open_prices_etf.parquet`
- Загрузка батчами по 100 тикеров, auto-adjust для сплитов/дивидендов
- Фильтрация тикеров с недостаточной историей

### Шаг 2. Расчёт индикаторов

**KAMA (Kaufman's Adaptive Moving Average)** — вычисляется для всех тикеров и периодов
параллельно (ProcessPoolExecutor). Используется как тренд-фильтр (не для ранжирования).

Оба индикатора ускорены через **Numba JIT** (cache=True).

### Шаг 3. Walk-Forward расписание

Скользящие окна:

- **In-Sample (IS):** 126 дней (≈6 месяцев) — оптимизация параметров
- **Out-of-Sample (OOS):** 21 день (≈1 месяц) — валидация

### Шаг 4a. Оптимизация параметров (Optuna)

- **Семплер:** TPE (Tree-structured Parzen Estimator)
- **Триалов:** 50 (по умолчанию)
- **Целевая функция:** CAGR (максимизация) с ограничением MaxDD ≤ 30%
- **Параллелизм:** ProcessPoolExecutor, батчевая отправка триалов

### Шаг 5. Сшивка OOS-эквити

OOS-кривые всех шагов конкатенируются хронологически. Результат —
агрегированная OOS-производительность стратегии.

---

## Алгоритмы отбора активов

### R² Momentum scoring (метод Кленова)

Для каждого актива фитим OLS-регрессию к лог-ценам за последние N дней:

```
log_prices = log(close[-N:])
slope, intercept = polyfit(x, log_prices, 1)
annualized_return = exp(slope × 252) − 1
R² = 1 − SS_res / SS_tot
score = annualized_return × R²
```

R² штрафует нестабильный тренд:

| R² | Эффект |
|---|---|
| 0.9 (идеальный тренд) | Сохраняет 90% скора |
| 0.5 (средний) | Срезает 50% |
| 0.2 (хаотичный) | Оставляет 20% |

### Каскад фильтров

1. **SPY KAMA режим:** `SPY_close > KAMA(SPY) × (1 − buffer)` — бычий рынок
2. **Asset KAMA тренд:** `close > KAMA(asset) × (1 − buffer)` — актив в тренде
3. **Gap фильтр:** никаких однодневных движений > 15% за последние 90 дней
4. **R² Momentum score > 0** — положительный и стабильный тренд

### Правила входа и выхода

**Вход:** Top-N по R² Momentum score. Сигналы на Close(T), исполнение на Open(T+1).

**Выход (Lazy Hold):** позиция продаётся при:
- KAMA breach: `close < KAMA × (1 − buffer)`
- SPY режим off
- Score < 0 или провал фильтров

Позиция **не** продаётся из-за падения в рейтинге. Пока тренд держится — держим.

### Размер позиций — ATR Risk Parity

```
weight[i] = (risk_factor / (ATR[i] / price[i])) / Σ(...)
```

ATR = средний абсолютный дневной сдвиг за N дней. Низко-ATR активы (облигации)
получают больше капитала. Нормализация к сумме = 1.0, без плеча.

### Ребалансирование

Проверка сигналов каждые N недель (по умолчанию: 2). Между датами ребалансирования
позиции удерживаются без изменений (lazy-hold).

---

## Параметры стратегии

### Основные параметры

| Параметр | По умолч. | Диапазон WFO | Описание |
|---|---|---|---|
| `r2_lookback` | 90 | 20–120 (шаг 20) | Окно OLS-регрессии для R² скоринга |
| `kama_asset_period` | 40 | 10, 20, 30, 40, 50 | KAMA для тренд-фильтра актива |
| `kama_spy_period` | 40 | 20, 30, 40, 50 | KAMA для режимного фильтра SPY |
| `kama_buffer` | 0.01 (1%) | 0.005–0.03 (шаг 0.005) | Буфер гистерезиса |
| `gap_threshold` | 0.15 (15%) | 0.10–0.20 (шаг 0.025) | Порог исключения гэпов |
| `atr_period` | 20 | 10–30 (шаг 5) | Окно ATR для сайзинга |
| `top_n` | 10 | 5–25 (шаг 5) | Макс. позиций в портфеле |
| `rebal_period_weeks` | 2 | 1–6 (шаг 1) | Период ребалансирования (недели) |

### Фиксированные параметры

| Параметр | Значение | Описание |
|---|---|---|
| `INITIAL_CAPITAL` | $10,000 | Стартовый капитал |
| `COMMISSION_RATE` | 0.02% (2 bps) | Комиссия брокера |
| `SLIPPAGE_RATE` | 0.05% (5 bps) | Проскальзывание |
| `RISK_FREE_RATE` | 4% годовых | Для расчёта Sharpe Ratio |
| `RISK_FACTOR` | 0.001 (10 bps) | Риск на позицию в день |

---

## Метрики производительности

| Метрика | Формула | Что показывает |
|---|---|---|
| Total Return | equity_end / equity_start − 1 | Кумулятивная доходность |
| CAGR | (equity_end / equity_start)^(252/days) − 1 | Среднегодовая доходность |
| Max Drawdown | max(peak − trough) / peak | Макс. просадка от пика |
| Sharpe Ratio | (CAGR − risk_free) / ann_vol | Доходность на единицу риска |
| Calmar Ratio | CAGR / max_drawdown | Доходность на единицу просадки |
| Annualized Vol | std(daily_returns) × √252 | Годовая волатильность |
| Win Rate | дней с return > 0 / всего дней | Доля прибыльных дней |

---

## Использование

### CLI: Walk-Forward оптимизация

```bash
# Установка
pip install -e .

# Запуск WFO (параметры по умолчанию)
python -m src.portfolio_sim walk-forward

# С указанием параметров
python -m src.portfolio_sim walk-forward \
    --period 3y \
    --n-trials 50 \
    --n-workers 8 \
    --refresh
```

| Флаг | По умолч. | Описание |
|---|---|---|
| `--period` | 3y | Период данных (формат yfinance) |
| `--n-trials` | 50 | Кол-во триалов Optuna на каждый IS-шаг |
| `--n-workers` | cpu_count − 1 | Параллельные воркеры |
| `--refresh` | — | Принудительная перезагрузка данных |
| `--oos-days` | 21 | Размер OOS-окна (торговых дней) |
| `--min-is-days` | 126 | Размер IS-окна (торговых дней) |

### Результаты

```
output/wfo_r2_YYYYMMDD_HHMMSS/
├── wfo_report.txt             # Сводный отчёт
├── wfo_steps.csv              # Метрики по каждому WFO-шагу
├── stitched_oos_equity.csv    # Дневная OOS-эквити
└── stitched_oos_equity.png    # График эквити (стратегия vs S&P 500)
```

### Streamlit Dashboard

```bash
streamlit run app.py
```

Две страницы:

- **Backtest** — интерактивный бэктест с настройкой R² параметров через слайдеры
- **Правила стратегії** — документация по стратегии

---

## Технологический стек

| Технология | Назначение |
|---|---|
| **Python 3.12+** | Язык |
| **Numba** | JIT-компиляция KAMA/ER (100x ускорение) |
| **Optuna** | Байесовская оптимизация параметров (TPE) |
| **Pandas / NumPy** | Работа с временными рядами |
| **yfinance** | Загрузка рыночных данных |
| **Streamlit** | Интерактивный дашборд |
| **Parquet** | Кэш данных (быстрый, компактный) |
| **ProcessPoolExecutor** | Параллелизм (обход GIL) |

---

## Структура проекта

```
src/portfolio_sim/
├── cli.py              # CLI-диспетчер
├── config.py           # Параметры, вселенная активов, пространство поиска
├── data.py             # Загрузка данных (yfinance + Parquet-кэш)
├── indicators.py       # KAMA и ER (Numba JIT)
├── reporting.py        # Метрики, графики, отчёты
├── cli_utils.py        # Общие CLI-утилиты
└── commands/
    └── walk_forward.py # CLI-обработчик команды walk-forward

scripts/
├── compare_methods.py      # R² Momentum backtest engine
├── wfo_r2_momentum.py      # Walk-Forward Optimization для R² стратегии
└── backtest_r2_params.py   # Бэктест с фиксированными WFO-параметрами
```
